{% extends 'app_rapports/base.html' %}
{% load static %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold text-dark d-flex align-items-center gap-2">
        <i class="bi bi-file-earmark-text text-primary"></i>
        Cr√©er un rapport
    </h2>
    <!-- Bouton Retour -->
    <a href="{% url 'report_list' %}"
       class="btn btn-primary rounded-pill px-4 shadow-sm">
        <i class="bi-arrow-left-short"></i>
        Retour
    </a>
</div>

<div class="card shadow-sm rounded-4 p-4 bg-light">
<form method="post" novalidate>
{% csrf_token %}

<!-- ================= INFO RAPPORT ================= -->
<h5 class="fw-semibold mb-3">
    <i class="bi bi-info-circle"></i> Informations du rapport
</h5>

<div class="mb-3">
    <label class="form-label fw-semibold">Nom du rapport</label>
    {{ form.name }}
    {% if form.name.errors %}
        <div class="text-danger small">
            {{ form.name.errors|striptags }}
        </div>
    {% endif %}
</div>

<div class="mb-3">
    <label class="form-label fw-semibold">Objet de l‚Äôemail</label>
    {{ form.subject }}
    {% if form.subject.errors %}
        <div class="text-danger small">
            {{ form.subject.errors|striptags }}
        </div>
    {% endif %}
</div>

<div class="mb-4">
    <label class="form-label fw-semibold">Message</label>
    {{ form.message }}
    {% if form.message.errors %}
        <div class="text-danger small">
            {{ form.message.errors|striptags }}
        </div>
    {% endif %}
</div>

<!-- ================= PLANIFICATION ================= -->
<hr>
<h5 class="fw-semibold mb-3">
    <i class="bi bi-clock"></i> Planification
</h5>

<div class="mb-3">
    <label class="form-label fw-semibold">Date d‚Äôex√©cution</label>
    {{ form.execute_at }}
    {% if form.execute_at.errors %}
        <div class="text-danger small">
            {{ form.execute_at.errors|striptags }}
        </div>
    {% endif %}
    <small class="text-muted">
        Obligatoire si le rapport n‚Äôest pas p√©riodique
    </small>
</div>

<input type="hidden" name="client_timezone" id="client_timezone">

<div class="form-check form-switch mb-3">
    {{ form.is_periodic }}
    <label class="form-check-label fw-semibold">
        Rapport p√©riodique
    </label>
    {% if form.is_periodic.errors %}
        <div class="text-danger small">
            {{ form.is_periodic.errors|striptags }}
        </div>
    {% endif %}
</div>

<div class="row g-3 mb-4" id="periodic-block" style="display:none;">
    <div class="col-md-4">
        <label class="form-label fw-semibold">Type</label>
        {{ form.periodic_type }}
        {% if form.periodic_type.errors %}
            <div class="text-danger small">
                {{ form.periodic_type.errors|striptags }}
            </div>
        {% endif %}
    </div>

    <div class="col-md-4" id="weekly-only" style="display:none;">
        <label class="form-label fw-semibold">Jour de la semaine</label>
        {{ form.periodic_weekday }}
        {% if form.periodic_weekday.errors %}
            <div class="text-danger small">
                {{ form.periodic_weekday.errors|striptags }}
            </div>
        {% endif %}
    </div>

    <div class="col-md-4" id="monthly-only" style="display:none;">
        <label class="form-label fw-semibold">Jour du mois</label>
        {{ form.periodic_monthday }}
        {% if form.periodic_monthday.errors %}
            <div class="text-danger small">
                {{ form.periodic_monthday.errors|striptags }}
            </div>
        {% endif %}
    </div>

    <div class="col-md-4">
        <label class="form-label fw-semibold">Heure</label>
        {{ form.periodic_time }}
        {% if form.periodic_time.errors %}
            <div class="text-danger small">
                {{ form.periodic_time.errors|striptags }}
            </div>
        {% endif %}
    </div>
</div>

<!-- ================= DESTINATAIRES ================= -->
<hr>
<h5 class="fw-semibold mb-2">
    <i class="bi bi-people"></i> Destinataires
</h5>

<div class="mb-3">
    <label class="form-label fw-semibold">√Ä</label>
    {{ form.to_emails }}
    {% if form.to_emails.errors %}
        <div class="text-danger small">
            {{ form.to_emails.errors|striptags }}
        </div>
    {% endif %}
    <small class="text-muted">
        Maintenez Ctrl pour s√©lectionner plusieurs emails
    </small>
</div>

<div class="mb-3">
    <label class="form-label fw-semibold">Copies CC</label>
    {{ form.cc_emails }}
    {% if form.cc_emails.errors %}
        <div class="text-danger small">
            {{ form.cc_emails.errors|striptags }}
        </div>
    {% endif %}
    <small class="text-muted">
        Maintenez Ctrl pour s√©lectionner plusieurs emails
    </small>
</div>

<!-- ================= REQU√äTES ================= -->
<hr>
<h5 class="fw-semibold mb-2">
    <i class="bi bi-database"></i> Requ√™tes associ√©es
</h5>

<!-- üîé Champ de recherche -->
<input type="text"
       id="querySearch"
       class="form-control form-control-sm rounded-pill mb-2"
       placeholder="üîé Rechercher par nom de requ√™te">

<div class="mb-4">
    {{ form.queries }}
    {% if form.queries.errors %}
        <div class="text-danger small">
            {{ form.queries.errors|striptags }}
        </div>
    {% endif %}
    <small class="text-muted">
        S√©lectionnez les requ√™tes √† ex√©cuter pour ce rapport
    </small>
</div>

<!-- ================= SUBMIT ================= -->
<button type="submit" class="btn btn-success rounded-pill w-100 py-2 fw-semibold">
    <i class="bi bi-check-circle-fill"></i> Enregistrer
</button>

</form>
</div>

<!-- ================= JS ================= -->
<script>
// timezone
document.getElementById("client_timezone").value =
    Intl.DateTimeFormat().resolvedOptions().timeZone;

// date minimale
const executeInput = document.getElementById("id_execute_at");
if (executeInput) {
    const now = new Date();
    now.setMinutes(now.getMinutes() + 1);
    executeInput.min = now.toISOString().slice(0, 16);
}

// p√©riodique
const periodicSwitch = document.getElementById("id_is_periodic");
const periodicBlock = document.getElementById("periodic-block");
const periodicType = document.getElementById("id_periodic_type");
const weeklyOnly = document.getElementById("weekly-only");
const monthlyOnly = document.getElementById("monthly-only");

function togglePeriodic() {
    periodicBlock.style.display = periodicSwitch.checked ? "flex" : "none";
    if (executeInput) executeInput.disabled = periodicSwitch.checked;
}
togglePeriodic();
periodicSwitch.addEventListener("change", togglePeriodic);

periodicType?.addEventListener("change", () => {
    weeklyOnly.style.display = "none";
    monthlyOnly.style.display = "none";
    if (periodicType.value === "weekly") weeklyOnly.style.display = "block";
    if (periodicType.value === "monthly") monthlyOnly.style.display = "block";
});


document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("querySearch");
    const select = document.getElementById("id_queries");

    if (!searchInput || !select) return;

    const options = Array.from(select.options);

    searchInput.addEventListener("input", function () {
        const value = this.value.toLowerCase();

        options.forEach(option => {
            const text = option.text.toLowerCase();
            option.style.display =
                value === "" || text.startsWith(value)
                ? "block"
                : "none";
        });
    });
});
</script>

<!-- ================= STYLE ================= -->
<style>
select[multiple] {
    border-radius: .6rem;
    min-height: 140px;
}
.card input,
.card textarea,
.card select {
    border-radius: .5rem;
}
</style>

{% endblock %}
