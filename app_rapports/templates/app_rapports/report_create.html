{% extends 'app_rapports/base.html' %}
{% load static %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">

    <h2 class="fw-bold text-dark d-flex align-items-center gap-2">
        <i class="bi bi-file-earmark-text text-primary"></i>
        {% if is_edit %}
           Modifier le rapport
        {% else %}
          Cr√©er un rapport
        {% endif %}
    </h2>

    <!-- Bouton Retour -->
    <a href="{% url 'report_list' %}"
       class="btn btn-primary rounded-pill px-4 shadow-sm">
        <i class="bi-arrow-left-short"></i>
        Retour
    </a>
</div>

<div class="card shadow-sm rounded-4 p-4 bg-light">
<form method="post" novalidate>
{% csrf_token %}

<!-- ================= INFO RAPPORT ================= -->
<h5 class="fw-semibold mb-3">
    <i class="bi bi-info-circle"></i> Informations du rapport
</h5>

<div class="mb-3">
    <label class="form-label fw-semibold">Nom du rapport</label>
    {{ form.name }}
    {% if form.name.errors %}
        <div class="text-danger small">
            {{ form.name.errors|striptags }}
        </div>
    {% endif %}
</div>

<div class="mb-3">
    <label class="form-label fw-semibold">Objet de l‚Äôemail</label>
    {{ form.subject }}
    {% if form.subject.errors %}
        <div class="text-danger small">
            {{ form.subject.errors|striptags }}
        </div>
    {% endif %}
</div>

<div class="mb-4">
    <label class="form-label fw-semibold">Message</label>
    {{ form.message }}
    {% if form.message.errors %}
        <div class="text-danger small">
            {{ form.message.errors|striptags }}
        </div>
    {% endif %}
</div>

<!-- ================= PLANIFICATION ================= -->
<!-- <hr> -->
<h5 class="fw-semibold mb-3">
    <i class="bi bi-clock"></i> Planification
</h5>

<div class="mb-3">
    <label class="form-label fw-semibold">Rapport non p√©riodique choisir date d‚Äôex√©cution </label>
    {{ form.execute_at }}
    {% if form.execute_at.errors %}
        <div class="text-danger small">
            {{ form.execute_at.errors|striptags }}
        </div>
    {% endif %}
</div>
<br>
<!-- p√©riodique -->
<input type="hidden" name="client_timezone" id="client_timezone">

<div class="form-check form-switch mb-3 d-flex align-items-center gap-2">
    {{ form.is_periodic }}

    <label class="form-check-label fw-semibold" for="id_is_periodic">
        Rapport p√©riodique
    </label>

     <button type="button"
        id="periodic-badge"
        class="btn btn-sm btn-outline-secondary rounded-pill px-3"
        disabled>
       D√©sactiv√©
       </button>
    {% if form.is_periodic.errors %}
        <div class="text-danger small">
            {{ form.is_periodic.errors|striptags }}
        </div>
    {% endif %}
</div>

<div class="row g-3 mb-4" id="periodic-block" style="display:none;">
    <div class="col-md-4">
        <label class="form-label fw-semibold">Type</label>
        {{ form.periodic_type }}
        {% if form.periodic_type.errors %}
            <div class="text-danger small">
                {{ form.periodic_type.errors|striptags }}
            </div>
        {% endif %}
    </div>

    <div class="col-md-4" id="weekly-only" style="display:none;">
        <label class="form-label fw-semibold">Jour de la semaine</label>
        {{ form.periodic_weekday }}
        {% if form.periodic_weekday.errors %}
            <div class="text-danger small">
                {{ form.periodic_weekday.errors|striptags }}
            </div>
        {% endif %}
    </div>

    <div class="col-md-4" id="monthly-only" style="display:none;">
        <label class="form-label fw-semibold">Jour du mois</label>
        {{ form.periodic_monthday }}
        {% if form.periodic_monthday.errors %}
            <div class="text-danger small">
                {{ form.periodic_monthday.errors|striptags }}
            </div>
        {% endif %}
    </div>

    <div class="col-md-4">
        <label class="form-label fw-semibold">Heure</label>
        {{ form.periodic_time }}
        {% if form.periodic_time.errors %}
            <div class="text-danger small">
                {{ form.periodic_time.errors|striptags }}
            </div>
        {% endif %}
    </div>
</div>
<br>
<!-- ================= DESTINATAIRES ================= -->
<!-- <hr> -->
<h5 class="fw-semibold mb-2">
    <i class="bi bi-people"></i> Destinataires
</h5>

<!-- ================= TO ================= -->
<div class="mb-2">
    <label class="form-label fw-semibold">√Ä</label>
    <ul id="to-email-list" class="list-group mb-2">
        {% for email in to_emails %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                {{ email.email }}
                  <button type="button"
                    class="btn btn-sm btn-danger"
                    onclick="removeEmail('to', '{{ email.email }}')">
                   <i class="bi bi-trash"></i>
                  </button>
                 <input type="hidden" name="to_emails[]" value="{{ email.email }}">
             </li>
        {% endfor %}
    </ul>

</div>

<div class="input-group mb-3">
    <input id="new-to-email" type="email" class="form-control" placeholder="Ajouter email √Ä">
    <button type="button" class="btn btn-primary" onclick="addEmail('to')">
        <i class="bi bi-plus-circle"></i>
    </button>
</div>
<div id="to-email-error" class="text-danger small mb-3"></div>

<!-- Email est Obligatoire -->
{% if form.non_field_errors %}
  <div class="text-danger small mb-2">
    {{ form.non_field_errors.0 }}
  </div>
{% endif %}
<!-- ================= CC ================= -->
<div class="mb-2">
    <label class="form-label fw-semibold">Copies CC</label>
        <ul id="cc-email-list" class="list-group mb-2">
            {% for email in cc_emails %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    {{ email.email }}
                        <button type="button"
                         class="btn btn-sm btn-danger"
                          onclick="removeEmail('cc', '{{ email.email }}')">
                           <i class="bi bi-trash"></i>
                        </button>
                        <input type="hidden" name="cc_emails[]" value="{{ email.email }}">
                </li>
            {% endfor %}
        </ul>

</div>

<div class="input-group mb-3">
    <input id="new-cc-email" type="email" class="form-control" placeholder="Ajouter email CC">
    <button type="button" class="btn btn-primary" onclick="addEmail('cc')">
        <i class="bi bi-plus-circle"></i>
    </button>
</div>
<div id="cc-email-error" class="text-danger small mb-3"></div>

<!-- ================= REQU√äTES ================= -->
<!-- <hr> -->
<h5 class="fw-semibold mb-2">
    <i class="bi bi-database"></i> Requ√™tes associ√©es
</h5>
<br>
<!-- üîé Champ de recherche -->
<input type="text"
       id="querySearch"
       class="form-control form-control-sm rounded-pill mb-2"
       placeholder="üîé Rechercher par nom de requ√™te">

<div class="mb-4">
    {{ form.queries }}
    {% if form.queries.errors %}
        <div class="text-danger small">
            {{ form.queries.errors|striptags }}
        </div>
    {% endif %}
    <small class="text-muted">
         Maintenez Ctrl pour s√©lectionner plusieurs requ√™tes √† ex√©cuter pour ce rapport
    </small>
</div>

<h5 class="fw-semibold">
    <i class="bi bi-sliders"></i> Param√®tre de requ√™te
</h5>

<div id="params-container"></div>
<br>
<br>
<!-- ================= SUBMIT ================= -->

<button type="submit" class="btn btn-success rounded-pill w-100 py-2 fw-semibold">
    <i class="bi bi-check-circle-fill"></i>
    {% if is_edit %}Mettre √† jour{% else %}Enregistrer{% endif %}
</button>


</form>
</div>

<!-- ================= JS ================= -->
<script>
// timezone
document.getElementById("client_timezone").value =
    Intl.DateTimeFormat().resolvedOptions().timeZone;

// date minimale
const executeInput = document.getElementById("id_execute_at");
if (executeInput) {
    const now = new Date();
    now.setMinutes(now.getMinutes() + 1);
    executeInput.min = now.toISOString().slice(0, 16);
}

// p√©riodique
const periodicSwitch = document.getElementById("id_is_periodic");
const periodicBlock = document.getElementById("periodic-block");
const periodicType = document.getElementById("id_periodic_type");
const weeklyOnly = document.getElementById("weekly-only");
const monthlyOnly = document.getElementById("monthly-only");

function togglePeriodic() {
    periodicBlock.style.display = periodicSwitch.checked ? "flex" : "none";
    if (executeInput) executeInput.disabled = periodicSwitch.checked;
}
togglePeriodic();
periodicSwitch.addEventListener("change", togglePeriodic);

periodicType?.addEventListener("change", () => {
    weeklyOnly.style.display = "none";
    monthlyOnly.style.display = "none";
    if (periodicType.value === "weekly") weeklyOnly.style.display = "block";
    if (periodicType.value === "monthly") monthlyOnly.style.display = "block";
});


document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("querySearch");
    const select = document.getElementById("id_queries");

    if (!searchInput || !select) return;

    const options = Array.from(select.options);

    searchInput.addEventListener("input", function () {
        const value = this.value.toLowerCase();

        options.forEach(option => {
            const text = option.text.toLowerCase();
            option.style.display =
                value === "" || text.startsWith(value)
                ? "block"
                : "none";
        });
    });
});


// LES PARAM√àTRES
document.getElementById("id_queries").addEventListener("change", function () {
    fetch("{% url 'query_parameters' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            query_ids: Array.from(this.selectedOptions).map(o => o.value)
        })
    })
    .then(r => r.json())
    .then(data => {
        const c = document.getElementById("params-container");
        c.innerHTML = "";

        data.forEach(p => {
            c.innerHTML += `
                <div class="mb-2">
                    <label class="form-label fw-semibold">
                        ${p.query_name} ‚Üí ${p.param}
                    </label>
                    <input type="text"
                           name="param_${p.query_id}_${p.param}"
                           class="form-control">
                </div>
            `;
        });
    });
});


// ===== Validation email =====
function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

// ===== Ajouter email =====
function addEmail(type) {
    const input = document.getElementById(`new-${type}-email`);
    const list = document.getElementById(`${type}-email-list`);
    const errorDiv = document.getElementById(`${type}-email-error`);
    const email = input.value.trim();

    errorDiv.textContent = "";

    if (!email) {
        errorDiv.textContent = "Veuillez saisir un email.";
        return;
    }
    if (!isValidEmail(email)) {
        errorDiv.textContent = "Format d‚Äôemail invalide.";
        return;
    }

    // V√©rifier doublon
    const exists = Array.from(list.querySelectorAll("input")).some(i => i.value === email);
    if (exists) {
        errorDiv.textContent = "Email d√©j√† ajout√©.";
        return;
    }

    // Ajouter √† la liste
    const li = document.createElement("li");
    li.className = "list-group-item d-flex justify-content-between align-items-center";
    li.innerHTML = `
        ${email}
        <button type="button" class="btn btn-sm btn-danger" onclick="removeEmail('${type}', '${email}')">
            <i class="bi bi-trash"></i>
        </button>
        <input type="hidden" name="${type}_emails[]" value="${email}">
    `;
    list.appendChild(li);
    input.value = "";
}

// ===== Supprimer email =====
function removeEmail(type, email) {
    const list = document.getElementById(`${type}-email-list`);
    const item = Array.from(list.children).find(li => li.querySelector("input").value === email);
    if (item) list.removeChild(item);
}


// BOTTON CHEK

const periodicBadge = document.getElementById("periodic-badge");

function updatePeriodicBadge() {
    if (periodicSwitch.checked) {
        periodicBadge.textContent = "Activ√©";
        periodicBadge.className =
            "btn btn-sm btn-success rounded-pill px-3";
    } else {
        periodicBadge.textContent = "D√©sactiv√©";
        periodicBadge.className =
            "btn btn-sm btn-secondary rounded-pill px-3";
    }
}

updatePeriodicBadge();
periodicSwitch.addEventListener("change", updatePeriodicBadge);


</script>

<!-- ================= STYLE ================= -->
<style>
select[multiple] {
    border-radius: .6rem;
    min-height: 140px;
}
.card input,
.card textarea,
.card select {
    border-radius: .5rem;
}
</style>


{% endblock %}
