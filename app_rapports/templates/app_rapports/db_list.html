        {% extends 'app_rapports/base.html' %}

        {% block content %}

        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold text-dark mb-0 d-flex align-items-center gap-2">
                <i class="bi bi-hdd-network text-primary"></i> Bases de donn√©es
            </h2>
            <input type="text"
               id="searchDB"
               class="form-control form-control-sm rounded-pill"
               placeholder="üîç Rechercher par nom..."
               style="width: 400px;">


            <a href="{% url 'db_create' %}" 
            class="btn btn-primary px-4 py-2 rounded-pill shadow-sm d-flex align-items-center gap-2">
                <i class="bi bi-database-add"></i> Ajouter base
            </a>
        </div>

        <!-- Table -->
        <div class="card border-0 shadow-sm rounded-4">
            <div class="card-body p-0">

                <div class="table-responsive">
                    <table class="table table-hover table-nowrap align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="py-3 px-4">Nom</th>
                                <th class="py-3">Type</th>
                                <th class="py-3">H√¥te</th>
                                <th class="py-3">Port</th>
                                <th class="py-3">Base</th>
                                <th class="py-3 text-center">Statut</th>
                                <th class="py-3 text-center">Actions</th>

                            </tr>
                        </thead>

                       <tbody>
                          {% for db in dbs %}
                         <tr class="hover-row">

                            <td class="fw-semibold px-4">{{ db.name }}</td>

                            <td>
                               {% if db.db_type == "mysql" %}
                                <span class="badge bg-info rounded-pill">
                                  <i class="bi bi-database"></i> MySQL
                               </span>
                               {% elif db.db_type == "oracle" %}
                               <span class="badge bg-danger rounded-pill">
                                 <i class="bi bi-hdd-stack"></i> Oracle
                              </span>
                              {% elif db.db_type == "postgres" %}
                              <span class="badge bg-primary rounded-pill">
                                 <i class="bi bi-server"></i> PostgreSQL
                              </span>
                              {% endif %}
                            </td>

                            <td>{{ db.host }}</td>
                            <td>{{ db.port }}</td>
                            <td>{{ db.database_name }}</td>

                                <!-- Statut -->
                            <td id="status-{{ db.id }}" class="text-center">
                                <button
                                  class="btn btn-primary btn-sm rounded-pill shadow-sm px-3 d-flex align-items-center gap-1 mx-auto"
                                  onclick="testConnexion('{{ db.id }}')">
                                  <i class="bi bi-play-circle"></i> Tester
                                </button>
                            </td>

                              <!-- Actions -->
                            <td class="text-center">
                              <div class="d-flex justify-content-center gap-2">

                                <!-- Modifier -->
                                <a href="{% url 'db_update' db.id %}"
                                  class="btn btn-warning btn-sm rounded-pill px-3">
                                     <i class="bi bi-pencil-square"></i>
                                </a>

                                <!-- Supprimer -->
                                 
                                {% if db.sqlquery_set.exists %}
                                <button class="btn btn-secondary btn-sm rounded-pill px-3" disabled>
                                       <i class="bi bi-lock"></i>
                                 </button>
                                {% else %}
                                <a href="{% url 'db_delete' db.id %}"
                                  class="btn btn-danger btn-sm rounded-pill px-3"
                                   onclick="return confirm('‚ö† Voulez-vous vraiment supprimer cette base ?');">
                                    <i class="bi bi-trash"></i>
                                </a>
                                {% endif %}


                             </div>
                            </td>

                            </tr>
                              {% empty %}
                            <tr>
                            <td colspan="7" class="text-center text-muted py-5 fs-6">
                              <i class="bi bi-database-x fs-3 d-block mb-2"></i>
                                 Aucune base disponible pour le moment.
                            </td>
                            </tr>
                           {% endfor %}
                        </tbody>

                    </table>
                </div>

            </div>
        </div>

        <!-- Test Script -->
        <script>
        function testConnexion(id) {
            const status = document.getElementById(`status-${id}`);

            status.innerHTML = `
                <span class="badge bg-warning text-dark rounded-pill px-3 py-2">
                    <i class="bi bi-hourglass-split"></i> Test...
                </span>
            `;

            fetch(`/databases/test/${id}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        status.innerHTML = `
                            <span class="badge bg-success rounded-pill px-3 py-2">
                                <i class="bi bi-check-circle"></i> Succ√®s
                            </span>
                        `;
                    } else {
                        status.innerHTML = `
                            <span class="badge bg-danger rounded-pill px-3 py-2">
                                <i class="bi bi-x-circle"></i> √âchec
                            </span>
                        `;
                    }
                })
                .catch(() => {
                    status.innerHTML = `
                        <span class="badge bg-danger rounded-pill px-3 py-2">
                            <i class="bi bi-exclamation-octagon"></i> Erreur
                        </span>
                    `;
                });
        }



        document.addEventListener("DOMContentLoaded", function () {
             const searchInput = document.getElementById("searchDB");
            const rows = document.querySelectorAll("table tbody tr");

           searchInput.addEventListener("input", function () {
            const filter = this.value.toLowerCase();

           rows.forEach(row => {
            const nameCell = row.querySelector("td:nth-child(1)");
            if (!nameCell) return;

            const nameText = nameCell.textContent.toLowerCase();
            row.style.display = nameText.includes(filter) ? "" : "none";
             });
           });
        });
    
        document.addEventListener("DOMContentLoaded", function () {
          const tbody = document.querySelector("table tbody");
          const rows = Array.from(tbody.querySelectorAll("tr"));

          // üîº Tri par NOM (A ‚Üí Z)
           rows.sort((a, b) => {
           const nameA = a.querySelector("td:nth-child(1)")?.textContent.trim().toLowerCase() || "";
           const nameB = b.querySelector("td:nth-child(1)")?.textContent.trim().toLowerCase() || "";
             return nameA.localeCompare(nameB);
           });

          // R√©injection dans le tbody
           rows.forEach(row => tbody.appendChild(row));
        });

        </script>

        <!-- Styles PRO -->
        <style>
        .table-nowrap td, .table-nowrap th {
            white-space: nowrap;
        }

        .hover-row:hover {
            background: #f5f7fa !important;
            transition: 0.25s ease;
        }

        .card {
            border-radius: 1rem !important;
        }

        .btn-outline-primary {
            font-weight: 500;
        }

        .badge {
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        </style>

        {% endblock %}
